"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crlf-normalize"),t=require("string-split-keep"),r=require("err-code"),n=require("util");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=a(t),o=a(r);function l(e){return e.trim()}function i(e){return null==e}function c(e){return("number"==typeof e||"string"==typeof e)&&/^\d+$/.test(e.toString())}const u=/^([a-z][a-z0-9_]*):(?: ([\s\S]*))?$/i,p=/^at\s+/,f=/^eval\s+at\s+/,d=/^([ \t]*)(.+)$/;function v(e,t,r){if(!e.endsWith(r))return[e];let n,a=e.length-1,s=1;for(;--a>=0;){const o=e.charAt(a);if(o===r)s++;else if(o===t&&0==--s){n=a;break}}return[e.slice(0,n),e.slice(n+1,-1)].map(l)}function g(e){return!i(e)&&("object"==typeof e&&i(e.line)&&i(e.col)?null:c(e.line)&&c(e.col))}function x(e){const[t,r,n]=s.default(e,":",-3);return null!=n&&n.length&&null!=r&&r.length?{source:t,line:r,col:n}:{source:e}}function m(e){const{indent:t,rawLine:r}=w(e),[n,a]=r.replace(f,"").split(/,\s+/g).map(l),{eval:s,callee:o,calleeNote:i,...c}=y(n);return{evalCallee:o,evalCalleeNote:i,...c,evalTrace:x(a),indent:t}}function w(e){const[,t,r]=d.exec(e);return{indent:t,rawLine:r}}function y(e,t){const{indent:r,rawLine:n}=w(e),a=n.replace(p,"");let[s,o]=v(a,"(",")");o||([s,o]=[o,s]);const l={};if(s){const[e,t]=v(s,"[","]");l.callee=e,l.calleeNote=t}else l.callee=s;return"eval"===l.callee&&(l.eval=!0),!0!==t||n.startsWith("at")?(Object.assign(l,t&&h(o)?m(o):x(o)),!0!==t||$(l)?(l.indent=r,l):{raw:!0,indent:r,rawLine:n}):{raw:!0,indent:r,rawLine:n}}function h(e){return f.test(e)}function $(e){var t;return!M(e)&&(e.eval||c(e.line)||i(e.callee)&&(null===(t=e.source)||void 0===t?void 0:t.length)>0&&g(e))}function T(t,r){var n;let a,s;if(!i(r)){let{type:n}=S(t),o=j({type:n,message:r});if(0===t.indexOf(o)){let r=t.replace(o,""),n=e.R_CRLF.exec(r);0===(null==n?void 0:n.index)&&(a=e.lineSplit(n.input.replace(n[0],"")),s=o)}}if(null===(n=s)||void 0===n||!n.length){[s,...a]=e.lineSplit(t);const r=a.findIndex((e=>e.trimLeft().startsWith("at")&&$(y(l(e),!0))));s=[s,...a.splice(0,r)].join("\n")}return{rawMessage:s,rawTrace:a}}function S(e){try{const[,t,r]=e.match(u);return{type:t,message:r}}catch(t){throw t.message=`Failed to parse body.\nreason: ${t.message}\nbody=${n.inspect(e)}`,o.default(t,{body:e}),t}}function b(e,t){if("string"!=typeof e)throw new TypeError("stack must be a string");try{const{rawMessage:r,rawTrace:n}=T(e,t),{type:a,message:s}=S(r);return{type:a,message:s,traces:n.map((e=>y(e,!0))),rawMessage:r,rawTrace:n,rawStack:e}}catch(r){throw o.default(r,{rawStack:e,detectMessage:t}),r}}function k({callee:e,calleeNote:t,source:r,line:n,col:a}){const s=[r,n,a].filter((e=>void 0!==e)).join(":");return e?`${e}${t?` [${t}]`:""} (${s})`:s}function L({callee:e,evalTrace:t,evalCallee:r,evalCalleeNote:n,...a}){return`${e} (eval at ${k({...a,callee:null!=r?r:"<anonymous>",calleeNote:n})}, ${k(t)})`}function j({type:e,message:t}){return`${e}: ${null!=t?t:""}`}function E(e){var t;return`${null!==(t=e.indent)&&void 0!==t?t:"    "}${e.rawLine}`}function M(e){return!0===e.raw}function N(e){return!0===e.eval}function C(e){var t;return M(e)?E(e):`${null!==(t=e.indent)&&void 0!==t?t:"    "}at ${N(e)?L(e):k(e)}`}class _{constructor(e,t){Object.assign(this,b(e,t))}filter(e){return this.traces=this.traces.filter(e),this}format(){return q(this)}}function q(e){var t,r;const{type:n,message:a}=e,s=`${j({type:n,message:a})}`,o=(null!==(t=null===(r=e.traces)||void 0===r?void 0:r.map(C))&&void 0!==t?t:e.rawTrace).join("\n");return o?s+"\n"+o:s}function O(e,t){return new _(e,t)}exports.ErrorStack=_,exports._detectIndent=w,exports.breakBrackets=v,exports.default=O,exports.formatEvalTrace=L,exports.formatMessage=j,exports.formatRawLineTrace=E,exports.formatTrace=k,exports.formatTraceLine=C,exports.formatTraces=function(e){return null==e?void 0:e.map(C)},exports.isEvalSource=h,exports.isEvalTrace=N,exports.isRawLineTrace=M,exports.parseBody=T,exports.parseErrorStack=O,exports.parseEvalSource=m,exports.parseMessage=S,exports.parseSource=x,exports.parseStack=b,exports.parseTrace=y,exports.stringifyErrorStack=q,exports.validPosition=g,exports.validTrace=$;
//# sourceMappingURL=error-stack2.cjs.production.min.js.map
