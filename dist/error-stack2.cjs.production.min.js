"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crlf-normalize"),t=require("string-split-keep"),r=require("err-code"),n=require("util");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=a(t),l=a(r);function s(e){return e.trim()}function i(e){return null==e}function c(e){return("number"==typeof e||"string"==typeof e)&&/^\d+$/.test(e.toString())}const u=/^([a-z][a-z0-9_]*)(?: \[(\w+)\])?:(?: ([\s\S]*))?$/i,p=/^at\s+/,f=/^eval\s+at\s+/,d=/^([ \t]*)(.+)$/;function v(e,t,r){if(!e.endsWith(r))return[e];let n,a=e.length-1,o=1;for(;--a>=0;){const l=e.charAt(a);if(l===r)o++;else if(l===t&&0==--o){n=a;break}}return[e.slice(0,n),e.slice(n+1,-1)].map(s)}function g(e){return!i(e)&&("object"==typeof e&&i(e.line)&&i(e.col)?null:c(e.line)&&c(e.col))}function x(e){const[t,r,n]=o.default(e,":",-3);return null!=n&&n.length&&null!=r&&r.length?{source:t,line:r,col:n}:{source:e}}function m(e){const{indent:t,rawLine:r}=w(e),[n,a]=r.replace(f,"").split(/,\s+/g).map(s),{eval:o,callee:l,calleeNote:i,...c}=h(n);return{evalCallee:l,evalCalleeNote:i,...c,evalTrace:x(a),indent:t}}function w(e){const[,t,r]=d.exec(e);return{indent:t,rawLine:r}}function h(e,t){const{indent:r,rawLine:n}=w(e),a=n.replace(p,"");let[o,l]=v(a,"(",")");l||([o,l]=[l,o]);const s={};if(o){const[e,t]=v(o,"[","]");s.callee=e,s.calleeNote=t}else s.callee=o;return"eval"===s.callee&&(s.eval=!0),!0!==t||n.startsWith("at")?(Object.assign(s,t&&y(l)?m(l):x(l)),!0!==t||$(s)?(s.indent=r,s):{raw:!0,indent:r,rawLine:n}):{raw:!0,indent:r,rawLine:n}}function y(e){return f.test(e)}function $(e){var t;return!M(e)&&(e.eval||c(e.line)||i(e.callee)&&(null===(t=e.source)||void 0===t?void 0:t.length)>0&&g(e))}function T(t,r){var n;let a,o;if(!i(r)){let{type:n}=S(t),l=j({type:n,message:r});if(0===t.indexOf(l)){let r=t.replace(l,""),n=e.R_CRLF.exec(r);0===(null==n?void 0:n.index)&&(a=e.lineSplit(n.input.replace(n[0],"")),o=l)}}if(null===(n=o)||void 0===n||!n.length){[o,...a]=e.lineSplit(t);const r=a.findIndex((e=>e.trimLeft().startsWith("at")&&$(h(s(e),!0))));o=[o,...a.splice(0,r)].join("\n")}return{rawMessage:o,rawTrace:a}}function S(e){try{const[,t,r,n]=e.match(u);return{type:t,code:r,message:n}}catch(t){throw t.message=`Failed to parse error message.\nreason: ${t.message}\nbody=${n.inspect(e)}`,l.default(t,{body:e}),t}}function b(e,t){if("string"!=typeof e)throw new TypeError("stack must be a string");try{const{rawMessage:r,rawTrace:n}=T(e,t),{type:a,code:o,message:l}=S(r);return{type:a,code:o,message:l,traces:n.map((e=>h(e,!0))),rawMessage:r,rawTrace:n,rawStack:e}}catch(r){throw l.default(r,{rawStack:e,detectMessage:t}),r}}function k({callee:e,calleeNote:t,source:r,line:n,col:a}){const o=[r,n,a].filter((e=>void 0!==e)).join(":");return e?`${e}${t?` [${t}]`:""} (${o})`:o}function L({callee:e,evalTrace:t,evalCallee:r,evalCalleeNote:n,...a}){return`${e} (eval at ${k({...a,callee:null!=r?r:"<anonymous>",calleeNote:n})}, ${k(t)})`}function j({type:e,code:t,message:r}){return null!=t&&t.length&&(e+=` [${t}]`),`${e}: ${null!=r?r:""}`}function E(e){var t;return`${null!==(t=e.indent)&&void 0!==t?t:"    "}${e.rawLine}`}function M(e){return!0===e.raw}function N(e){return!0===e.eval}function C(e){var t;return M(e)?E(e):`${null!==(t=e.indent)&&void 0!==t?t:"    "}at ${N(e)?L(e):k(e)}`}class _{constructor(e,t){Object.assign(this,b(e,t))}filter(e){return this.traces=this.traces.filter(e),this}format(){return q(this)}}function q(e){var t,r;const n=`${j(e)}`,a=(null!==(t=null===(r=e.traces)||void 0===r?void 0:r.map(C))&&void 0!==t?t:e.rawTrace).join("\n");return a?n+"\n"+a:n}function O(e,t){return new _(e,t)}exports.ErrorStack=_,exports._detectIndent=w,exports.breakBrackets=v,exports.default=O,exports.formatEvalTrace=L,exports.formatMessage=j,exports.formatRawLineTrace=E,exports.formatTrace=k,exports.formatTraceLine=C,exports.formatTraces=function(e){return null==e?void 0:e.map(C)},exports.isEvalSource=y,exports.isEvalTrace=N,exports.isRawLineTrace=M,exports.parseBody=T,exports.parseErrorStack=O,exports.parseEvalSource=m,exports.parseMessage=S,exports.parseSource=x,exports.parseStack=b,exports.parseTrace=h,exports.stringifyErrorStack=q,exports.validPosition=g,exports.validTrace=$;
//# sourceMappingURL=error-stack2.cjs.production.min.js.map
