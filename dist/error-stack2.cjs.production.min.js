"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crlf-normalize"),t=require("string-split-keep"),r=require("err-code"),n=require("util");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=a(t),s=a(r);function l(e){return e.trim()}function i(e){return null==e}function c(e){return("number"==typeof e||"string"==typeof e)&&/^\d+$/.test(e.toString())}const u=/^([a-z][a-z0-9_]*)(?: \[(\w+)\])?:(?: ([\s\S]*))?$/i,f=/^at\s+/,p=/^eval\s+at\s+/,d=/^([ \t]*)(.+)$/;function v(e,t,r){if(!e.endsWith(r))return[e];let n,a=e.length-1,o=1;for(;--a>=0;){const s=e.charAt(a);if(s===r)o++;else if(s===t&&0==--o){n=a;break}}return[e.slice(0,n),e.slice(n+1,-1)].map(l)}function x(e){return!i(e)&&("object"==typeof e&&i(e.line)&&i(e.col)?null:c(e.line)&&c(e.col))}function g(e){const[t,r,n]=o.default(e,":",-3);return null!=n&&n.length&&null!=r&&r.length?{source:t,line:r,col:n}:{source:e}}function m(e){const{indent:t,rawLine:r}=w(e),[n,a]=r.replace(p,"").split(/,\s+/g).map(l),{eval:o,callee:s,calleeNote:i,...c}=h(n);return{evalCallee:s,evalCalleeNote:i,...c,evalTrace:g(a),indent:t}}function w(e){const[,t,r]=d.exec(e);return{indent:t,rawLine:r}}function h(e,t){const{indent:r,rawLine:n}=w(e),a=n.replace(f,"");let[o,s]=v(a,"(",")");s||([o,s]=[s,o]);const l={};if(o){const[e,t]=v(o,"[","]");l.callee=e,l.calleeNote=t}else l.callee=o;return"eval"===l.callee&&(l.eval=!0),!0!==t||n.startsWith("at")?(Object.assign(l,t&&$(s)?m(s):g(s)),!0!==t||y(l)?(l.indent=r,l):{raw:!0,indent:r,rawLine:n}):{raw:!0,indent:r,rawLine:n}}function $(e){return p.test(e)}function y(e){var t;return!N(e)&&(e.eval||c(e.line)||i(e.callee)&&(null===(t=e.source)||void 0===t?void 0:t.length)>0&&x(e))}function T(t,r){var n;let a,o;if(!i(r)){let{type:n}=S(t),s=E({type:n,message:r});if(0===t.indexOf(s)){let r=t.replace(s,""),n=e.R_CRLF.exec(r);0===(null==n?void 0:n.index)&&(a=e.lineSplit(n.input.replace(n[0],"")),o=s)}}if(null===(n=o)||void 0===n||!n.length){[o,...a]=e.lineSplit(t);const r=a.findIndex((e=>e.trimLeft().startsWith("at")&&y(h(l(e),!0))));o=[o,...a.splice(0,r)].join("\n")}return{rawMessage:o,rawTrace:a}}function S(e){try{const[,t,r,n]=e.match(u);return{type:t,code:r,message:n}}catch(t){throw t.message=`Failed to parse error message.\nreason: ${t.message}\nbody=${n.inspect(e)}`,s.default(t,{body:e}),t}}function b(e,t){if("string"!=typeof e)throw new TypeError("stack must be a string");try{const{rawMessage:r,rawTrace:n}=T(e,t),{type:a,code:o,message:s}=S(r);return{type:a,code:o,message:s,traces:n.map((e=>h(e,!0))),rawMessage:r,rawTrace:n,rawStack:e}}catch(r){throw s.default(r,{rawStack:e,detectMessage:t}),r}}function k({callee:e,calleeNote:t,source:r,line:n,col:a}){const o=[r,n,a].filter((e=>void 0!==e)).join(":");return e?`${e}${t?` [${t}]`:""} (${o})`:o}function L({callee:e,evalTrace:t,evalCallee:r,evalCalleeNote:n,...a}){return`${e} (eval at ${k({...a,callee:null!=r?r:"<anonymous>",calleeNote:n})}, ${k(t)})`}function j({type:e,code:t}){return null!=t&&t.length&&(e+=` [${t}]`),`${e}`}function E(e){var t;return`${j(e)}: ${null!==(t=e.message)&&void 0!==t?t:""}`}function M(e){var t;return`${null!==(t=e.indent)&&void 0!==t?t:"    "}${e.rawLine}`}function N(e){return!0===e.raw}function C(e){return!0===e.eval}function _(e){var t;return N(e)?M(e):`${null!==(t=e.indent)&&void 0!==t?t:"    "}at ${C(e)?L(e):k(e)}`}class q{constructor(e,t){Object.assign(this,b(e,t))}filter(e){return this.traces=this.traces.filter(e),this}format(){return O(this)}}function O(e){var t,r;const n=`${E(e)}`,a=(null!==(t=null===(r=e.traces)||void 0===r?void 0:r.map(_))&&void 0!==t?t:e.rawTrace).join("\n");return a?n+"\n"+a:n}function R(e,t){return new q(e,t)}exports.ErrorStack=q,exports._detectIndent=w,exports.breakBrackets=v,exports.default=R,exports.formatEvalTrace=L,exports.formatMessage=E,exports.formatMessagePrefix=j,exports.formatRawLineTrace=M,exports.formatTrace=k,exports.formatTraceLine=_,exports.formatTraces=function(e){return null==e?void 0:e.map(_)},exports.isEvalSource=$,exports.isEvalTrace=C,exports.isRawLineTrace=N,exports.parseBody=T,exports.parseErrorStack=R,exports.parseEvalSource=m,exports.parseMessage=S,exports.parseSource=g,exports.parseStack=b,exports.parseTrace=h,exports.stringifyErrorStack=O,exports.validPosition=x,exports.validTrace=y;
//# sourceMappingURL=error-stack2.cjs.production.min.js.map
