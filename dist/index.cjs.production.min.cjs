"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crlf-normalize"),r=require("string-split-keep2"),t=require("err-code"),a=require("util"),n=require("string-detect-indent");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=_interopDefaultLegacy(t);function trim(e){return e.trim()}function isUnset(e){return null==e}function isNumOnly(e){return("number"==typeof e||"string"==typeof e)&&/^\d+$/.test(e.toString())}const i=/^([a-z][a-z0-9_]*)(?:(?: \[(\w+)\])?:(?: ([\s\S]*))?)?$/i,o=new RegExp(i.source,i.flags+"m"),c=/^at\s+/,l=/^eval\s+at\s+/;function breakBrackets(e,r,t){if(!e.endsWith(t))return[e];let a,n=e.length-1,s=1;for(;--n>=0;){const i=e.charAt(n);if(i===t)s++;else if(i===r&&0==--s){a=n;break}}return[e.slice(0,a),e.slice(a+1,-1)].map(trim)}function validPosition(e){return!isUnset(e)&&("object"==typeof e&&isUnset(e.line)&&isUnset(e.col)?null:isNumOnly(e.line)&&isNumOnly(e.col))}function parseSource(e){const[t,a,n]=r.stringSplitWithLimit(e,":",-3);return null!=n&&n.length&&null!=a&&a.length?{source:t,line:a,col:n}:{source:e}}function parseEvalSource(e){const{indent:r,rawLine:t}=_detectIndent(e),[a,n]=t.replace(l,"").split(/,\s+/g).map(trim),{eval:s,callee:i,calleeNote:o,...c}=parseTrace(a);return{evalCallee:i,evalCalleeNote:o,...c,evalTrace:parseSource(n),indent:r}}function _detectIndent(e){const{indent:r,body:t}=n.detectIndentLine(e);return{indent:r,rawLine:t}}function parseTrace(e,r){const{indent:t,rawLine:a}=_detectIndent(e),n=a.replace(c,"");let[s,i]=breakBrackets(n,"(",")");i||([s,i]=[i,s]);const o={};if(s){const[e,r]=breakBrackets(s,"[","]");o.callee=e,o.calleeNote=r}else o.callee=s;return"eval"===o.callee&&(o.eval=!0),!0!==r||a.startsWith("at")?(Object.assign(o,r&&isEvalSource(i)?parseEvalSource(i):parseSource(i)),!0!==r||validTrace(o)?(o.indent=t,o):{raw:!0,indent:t,rawLine:a}):{raw:!0,indent:t,rawLine:a}}function isEvalSource(e){return l.test(e)}function validTrace(e){var r;return!isRawLineTrace(e)&&(e.eval||isNumOnly(e.line)||isUnset(e.callee)&&(null===(r=e.source)||void 0===r?void 0:r.length)>0&&validPosition(e))}function parseBody(r,t){var a;let n,s;if(!isUnset(t)){let{type:a,message:i}=parseMessage(r,!0),o=formatMessage({type:a,message:""===t?i:t});if(0===r.indexOf(o)){let t=r.replace(o,""),a=e.R_CRLF.exec(t);0===(null==a?void 0:a.index)&&(n=e.lineSplit(a.input.replace(a[0],"")),s=o)}}if(null===(a=s)||void 0===a||!a.length){[s,...n]=e.lineSplit(r);const t=n.findIndex((e=>e.trimLeft().startsWith("at")&&validTrace(parseTrace(trim(e),!0))));s=[s,...n.splice(0,t)].join(e.LF)}return{rawMessage:s,rawTrace:n}}function parseMessage(e,r){try{const[,t,a,n]=e.match(r?o:i);return{type:t,code:a,message:n}}catch(r){throw r.message=`Failed to parse error message.\nreason: ${r.message}\nbody=${a.inspect(e)}`,s.default(r,{body:e}),r}}function parseStack(e,r){if("string"!=typeof e)throw s.default(new TypeError("stack must be a string"),{rawStack:e,detectMessage:r});try{const{rawMessage:t,rawTrace:a}=parseBody(e,r),{type:n,code:s,message:i}=parseMessage(t);return{type:n,code:s,message:i,traces:a.map((e=>parseTrace(e,!0))),rawMessage:t,rawTrace:a,rawStack:e}}catch(t){throw s.default(t,{rawStack:e,detectMessage:r}),t}}function formatTrace({callee:e,calleeNote:r,source:t,line:a,col:n}){const s=[t,a,n].filter((e=>void 0!==e)).join(":");return e?`${e}${r?` [${r}]`:""} (${s})`:s}function formatEvalTrace({callee:e,evalTrace:r,evalCallee:t,evalCalleeNote:a,...n}){return`${e} (eval at ${formatTrace({...n,callee:null!=t?t:"<anonymous>",calleeNote:a})}, ${formatTrace(r)})`}function formatMessagePrefix({type:e,code:r}){return null!=r&&r.length&&(e+=` [${r}]`),`${e}`}function formatMessage(e){let r=formatMessagePrefix(e);var t;return void 0!==e.message&&(r+=`: ${null!==(t=e.message)&&void 0!==t?t:""}`),r}function formatRawLineTrace(e){var r;return`${null!==(r=e.indent)&&void 0!==r?r:"    "}${e.rawLine}`}function isRawLineTrace(e){return!0===e.raw}function isEvalTrace(e){return!0===e.eval}function formatTraceLine(e){var r;return isRawLineTrace(e)?formatRawLineTrace(e):`${null!==(r=e.indent)&&void 0!==r?r:"    "}at ${isEvalTrace(e)?formatEvalTrace(e):formatTrace(e)}`}class ErrorStack{constructor(e,r){Object.assign(this,parseStack(e,r))}filter(e){return this.traces=this.traces.filter(e),this}format(){return stringifyErrorStack(this)}}function stringifyErrorStack(r){var t,a;const n=`${formatMessage(r)}`,s=(null!==(t=null===(a=r.traces)||void 0===a?void 0:a.map(formatTraceLine))&&void 0!==t?t:r.rawTrace).join(e.LF);return s?n+e.LF+s:n}function parseErrorStack(e,r){return new ErrorStack(e,r)}exports.ErrorStack=ErrorStack,exports._detectIndent=_detectIndent,exports.breakBrackets=breakBrackets,exports.default=parseErrorStack,exports.formatEvalTrace=formatEvalTrace,exports.formatMessage=formatMessage,exports.formatMessagePrefix=formatMessagePrefix,exports.formatRawLineTrace=formatRawLineTrace,exports.formatTrace=formatTrace,exports.formatTraceLine=formatTraceLine,exports.formatTraces=function formatTraces(e){return null==e?void 0:e.map(formatTraceLine)},exports.isEvalSource=isEvalSource,exports.isEvalTrace=isEvalTrace,exports.isRawLineTrace=isRawLineTrace,exports.parseBody=parseBody,exports.parseErrorStack=parseErrorStack,exports.parseEvalSource=parseEvalSource,exports.parseMessage=parseMessage,exports.parseSource=parseSource,exports.parseStack=parseStack,exports.parseTrace=parseTrace,exports.stringifyErrorStack=stringifyErrorStack,exports.validPosition=validPosition,exports.validTrace=validTrace;
//# sourceMappingURL=index.cjs.production.min.cjs.map
