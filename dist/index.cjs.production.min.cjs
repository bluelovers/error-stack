"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crlf-normalize"),r=require("string-split-keep2"),a=require("err-code"),t=require("util");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=_interopDefaultLegacy(a);function trim(e){return e.trim()}function isUnset(e){return null==e}function isNumOnly(e){return("number"==typeof e||"string"==typeof e)&&/^\d+$/.test(e.toString())}const n=/^([a-z][a-z0-9_]*)(?:(?: \[(\w+)\])?:(?: ([\s\S]*))?)?$/i,o=new RegExp(n.source,n.flags+"m"),i=/^at\s+/,c=/^eval\s+at\s+/,l=/^([ \t]*)(.+)$/;function breakBrackets(e,r,a){if(!e.endsWith(a))return[e];let t,s=e.length-1,n=1;for(;--s>=0;){const o=e.charAt(s);if(o===a)n++;else if(o===r&&0==--n){t=s;break}}return[e.slice(0,t),e.slice(t+1,-1)].map(trim)}function validPosition(e){return!isUnset(e)&&("object"==typeof e&&isUnset(e.line)&&isUnset(e.col)?null:isNumOnly(e.line)&&isNumOnly(e.col))}function parseSource(e){const[a,t,s]=r.stringSplitWithLimit(e,":",-3);return null!=s&&s.length&&null!=t&&t.length?{source:a,line:t,col:s}:{source:e}}function parseEvalSource(e){const{indent:r,rawLine:a}=_detectIndent(e),[t,s]=a.replace(c,"").split(/,\s+/g).map(trim),{eval:n,callee:o,calleeNote:i,...l}=parseTrace(t);return{evalCallee:o,evalCalleeNote:i,...l,evalTrace:parseSource(s),indent:r}}function _detectIndent(e){const[,r,a]=l.exec(e);return{indent:r,rawLine:a}}function parseTrace(e,r){const{indent:a,rawLine:t}=_detectIndent(e),s=t.replace(i,"");let[n,o]=breakBrackets(s,"(",")");o||([n,o]=[o,n]);const c={};if(n){const[e,r]=breakBrackets(n,"[","]");c.callee=e,c.calleeNote=r}else c.callee=n;return"eval"===c.callee&&(c.eval=!0),!0!==r||t.startsWith("at")?(Object.assign(c,r&&isEvalSource(o)?parseEvalSource(o):parseSource(o)),!0!==r||validTrace(c)?(c.indent=a,c):{raw:!0,indent:a,rawLine:t}):{raw:!0,indent:a,rawLine:t}}function isEvalSource(e){return c.test(e)}function validTrace(e){var r;return!isRawLineTrace(e)&&(e.eval||isNumOnly(e.line)||isUnset(e.callee)&&(null===(r=e.source)||void 0===r?void 0:r.length)>0&&validPosition(e))}function parseBody(r,a){var t;let s,n;if(!isUnset(a)){let{type:t,message:o}=parseMessage(r,!0),i=formatMessage({type:t,message:""===a?o:a});if(0===r.indexOf(i)){let a=r.replace(i,""),t=e.R_CRLF.exec(a);0===(null==t?void 0:t.index)&&(s=e.lineSplit(t.input.replace(t[0],"")),n=i)}}if(null===(t=n)||void 0===t||!t.length){[n,...s]=e.lineSplit(r);const a=s.findIndex((e=>e.trimLeft().startsWith("at")&&validTrace(parseTrace(trim(e),!0))));n=[n,...s.splice(0,a)].join(e.LF)}return{rawMessage:n,rawTrace:s}}function parseMessage(e,r){try{const[,a,t,s]=e.match(r?o:n);return{type:a,code:t,message:s}}catch(r){throw r.message=`Failed to parse error message.\nreason: ${r.message}\nbody=${t.inspect(e)}`,s.default(r,{body:e}),r}}function parseStack(e,r){if("string"!=typeof e)throw s.default(new TypeError("stack must be a string"),{rawStack:e,detectMessage:r});try{const{rawMessage:a,rawTrace:t}=parseBody(e,r),{type:s,code:n,message:o}=parseMessage(a);return{type:s,code:n,message:o,traces:t.map((e=>parseTrace(e,!0))),rawMessage:a,rawTrace:t,rawStack:e}}catch(a){throw s.default(a,{rawStack:e,detectMessage:r}),a}}function formatTrace({callee:e,calleeNote:r,source:a,line:t,col:s}){const n=[a,t,s].filter((e=>void 0!==e)).join(":");return e?`${e}${r?` [${r}]`:""} (${n})`:n}function formatEvalTrace({callee:e,evalTrace:r,evalCallee:a,evalCalleeNote:t,...s}){return`${e} (eval at ${formatTrace({...s,callee:null!=a?a:"<anonymous>",calleeNote:t})}, ${formatTrace(r)})`}function formatMessagePrefix({type:e,code:r}){return null!=r&&r.length&&(e+=` [${r}]`),`${e}`}function formatMessage(e){let r=formatMessagePrefix(e);var a;return void 0!==e.message&&(r+=`: ${null!==(a=e.message)&&void 0!==a?a:""}`),r}function formatRawLineTrace(e){var r;return`${null!==(r=e.indent)&&void 0!==r?r:"    "}${e.rawLine}`}function isRawLineTrace(e){return!0===e.raw}function isEvalTrace(e){return!0===e.eval}function formatTraceLine(e){var r;return isRawLineTrace(e)?formatRawLineTrace(e):`${null!==(r=e.indent)&&void 0!==r?r:"    "}at ${isEvalTrace(e)?formatEvalTrace(e):formatTrace(e)}`}class ErrorStack{constructor(e,r){Object.assign(this,parseStack(e,r))}filter(e){return this.traces=this.traces.filter(e),this}format(){return stringifyErrorStack(this)}}function stringifyErrorStack(r){var a,t;const s=`${formatMessage(r)}`,n=(null!==(a=null===(t=r.traces)||void 0===t?void 0:t.map(formatTraceLine))&&void 0!==a?a:r.rawTrace).join(e.LF);return n?s+e.LF+n:s}function parseErrorStack(e,r){return new ErrorStack(e,r)}exports.ErrorStack=ErrorStack,exports._detectIndent=_detectIndent,exports.breakBrackets=breakBrackets,exports.default=parseErrorStack,exports.formatEvalTrace=formatEvalTrace,exports.formatMessage=formatMessage,exports.formatMessagePrefix=formatMessagePrefix,exports.formatRawLineTrace=formatRawLineTrace,exports.formatTrace=formatTrace,exports.formatTraceLine=formatTraceLine,exports.formatTraces=function formatTraces(e){return null==e?void 0:e.map(formatTraceLine)},exports.isEvalSource=isEvalSource,exports.isEvalTrace=isEvalTrace,exports.isRawLineTrace=isRawLineTrace,exports.parseBody=parseBody,exports.parseErrorStack=parseErrorStack,exports.parseEvalSource=parseEvalSource,exports.parseMessage=parseMessage,exports.parseSource=parseSource,exports.parseStack=parseStack,exports.parseTrace=parseTrace,exports.stringifyErrorStack=stringifyErrorStack,exports.validPosition=validPosition,exports.validTrace=validTrace;
//# sourceMappingURL=index.cjs.production.min.cjs.map
