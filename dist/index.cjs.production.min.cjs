"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crlf-normalize"),t=require("string-split-keep2"),r=require("err-code"),n=require("util");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=a(r);function s(e){return e.trim()}function i(e){return null==e}function l(e){return("number"==typeof e||"string"==typeof e)&&/^\d+$/.test(e.toString())}const c=/^([a-z][a-z0-9_]*)(?:(?: \[(\w+)\])?:(?: ([\s\S]*))?)?$/i,u=/^at\s+/,p=/^eval\s+at\s+/,f=/^([ \t]*)(.+)$/;function d(e,t,r){if(!e.endsWith(r))return[e];let n,a=e.length-1,o=1;for(;--a>=0;){const s=e.charAt(a);if(s===r)o++;else if(s===t&&0==--o){n=a;break}}return[e.slice(0,n),e.slice(n+1,-1)].map(s)}function v(e){return!i(e)&&("object"==typeof e&&i(e.line)&&i(e.col)?null:l(e.line)&&l(e.col))}function g(e){const[r,n,a]=t.stringSplitWithLimit(e,":",-3);return null!=a&&a.length&&null!=n&&n.length?{source:r,line:n,col:a}:{source:e}}function x(e){const{indent:t,rawLine:r}=m(e),[n,a]=r.replace(p,"").split(/,\s+/g).map(s),{eval:o,callee:i,calleeNote:l,...c}=w(n);return{evalCallee:i,evalCalleeNote:l,...c,evalTrace:g(a),indent:t}}function m(e){const[,t,r]=f.exec(e);return{indent:t,rawLine:r}}function w(e,t){const{indent:r,rawLine:n}=m(e),a=n.replace(u,"");let[o,s]=d(a,"(",")");s||([o,s]=[s,o]);const i={};if(o){const[e,t]=d(o,"[","]");i.callee=e,i.calleeNote=t}else i.callee=o;return"eval"===i.callee&&(i.eval=!0),!0!==t||n.startsWith("at")?(Object.assign(i,t&&h(s)?x(s):g(s)),!0!==t||y(i)?(i.indent=r,i):{raw:!0,indent:r,rawLine:n}):{raw:!0,indent:r,rawLine:n}}function h(e){return p.test(e)}function y(e){var t;return!M(e)&&(e.eval||l(e.line)||i(e.callee)&&(null===(t=e.source)||void 0===t?void 0:t.length)>0&&v(e))}function $(t,r){var n;let a,o;if(!i(r)){let{type:n}=S(t),s=E({type:n,message:r});if(0===t.indexOf(s)){let r=t.replace(s,""),n=e.R_CRLF.exec(r);0===(null==n?void 0:n.index)&&(a=e.lineSplit(n.input.replace(n[0],"")),o=s)}}if(null===(n=o)||void 0===n||!n.length){[o,...a]=e.lineSplit(t);const r=a.findIndex((e=>e.trimLeft().startsWith("at")&&y(w(s(e),!0))));o=[o,...a.splice(0,r)].join(e.LF)}return{rawMessage:o,rawTrace:a}}function S(e){try{const[,t,r,n]=e.match(c);return{type:t,code:r,message:n}}catch(t){throw t.message=`Failed to parse error message.\nreason: ${t.message}\nbody=${n.inspect(e)}`,o.default(t,{body:e}),t}}function T(e,t){if("string"!=typeof e)throw new TypeError("stack must be a string");try{const{rawMessage:r,rawTrace:n}=$(e,t),{type:a,code:o,message:s}=S(r);return{type:a,code:o,message:s,traces:n.map((e=>w(e,!0))),rawMessage:r,rawTrace:n,rawStack:e}}catch(r){throw o.default(r,{rawStack:e,detectMessage:t}),r}}function L({callee:e,calleeNote:t,source:r,line:n,col:a}){const o=[r,n,a].filter((e=>void 0!==e)).join(":");return e?`${e}${t?` [${t}]`:""} (${o})`:o}function k({callee:e,evalTrace:t,evalCallee:r,evalCalleeNote:n,...a}){return`${e} (eval at ${L({...a,callee:null!=r?r:"<anonymous>",calleeNote:n})}, ${L(t)})`}function b({type:e,code:t}){return null!=t&&t.length&&(e+=` [${t}]`),`${e}`}function E(e){let t=b(e);var r;return void 0!==e.message&&(t+=`: ${null!==(r=e.message)&&void 0!==r?r:""}`),t}function j(e){var t;return`${null!==(t=e.indent)&&void 0!==t?t:"    "}${e.rawLine}`}function M(e){return!0===e.raw}function N(e){return!0===e.eval}function C(e){var t;return M(e)?j(e):`${null!==(t=e.indent)&&void 0!==t?t:"    "}at ${N(e)?k(e):L(e)}`}class ErrorStack{constructor(e,t){Object.assign(this,T(e,t))}filter(e){return this.traces=this.traces.filter(e),this}format(){return F(this)}}function F(t){var r,n;const a=`${E(t)}`,o=(null!==(r=null===(n=t.traces)||void 0===n?void 0:n.map(C))&&void 0!==r?r:t.rawTrace).join(e.LF);return o?a+e.LF+o:a}function _(e,t){return new ErrorStack(e,t)}exports.ErrorStack=ErrorStack,exports._detectIndent=m,exports.breakBrackets=d,exports.default=_,exports.formatEvalTrace=k,exports.formatMessage=E,exports.formatMessagePrefix=b,exports.formatRawLineTrace=j,exports.formatTrace=L,exports.formatTraceLine=C,exports.formatTraces=function(e){return null==e?void 0:e.map(C)},exports.isEvalSource=h,exports.isEvalTrace=N,exports.isRawLineTrace=M,exports.parseBody=$,exports.parseErrorStack=_,exports.parseEvalSource=x,exports.parseMessage=S,exports.parseSource=g,exports.parseStack=T,exports.parseTrace=w,exports.stringifyErrorStack=F,exports.validPosition=v,exports.validTrace=y;
//# sourceMappingURL=index.cjs.production.min.cjs.map
